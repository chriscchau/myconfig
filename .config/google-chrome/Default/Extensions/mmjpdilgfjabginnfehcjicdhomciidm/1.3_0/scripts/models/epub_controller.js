Readium.Models.EPUBController=Backbone.Model.extend({initialize:function(){var a=this;this.epub=this.get("epub");this.set("media_overlay_controller",new Readium.Models.MediaOverlayController({epubController:this}));this.paginator=new Readium.Models.PaginationStrategySelector({book:this});this.packageDocument=this.epub.getPackageDocument();this.packageDocument.fetch({success:function(){var b=a.restorePosition();a.set("spine_position",b);b=a.paginator.renderSpineItems(!1);a.set("rendered_spine_items",
b);a.set("has_toc",!!a.packageDocument.getTocItem())}});this.on("change:spine_position",this.savePosition,this);this.on("change:spine_position",this.setMetaSize,this)},save:function(a,b){var c={success:function(){}};_.extend(c,b);var d=this;this.set("updated_at",new Date);this.set("key",this.epub.get("key")+"_epubViewProperties");Lawnchair(function(){this.save(d.toJSON(),c.success)})},defaults:{font_size:10,two_up:!1,full_screen:!1,toolbar_visible:!0,toc_visible:!1,rendered_spine_items:[],current_theme:"default-theme",
current_margin:3},toJSON:function(){return{updated_at:this.get("updated_at"),current_theme:this.get("current_theme"),current_margin:this.get("current_margin"),two_up:this.get("two_up"),font_size:this.get("font_size"),key:this.get("key")}},toggleFullScreen:function(){this.set({full_screen:!this.get("full_screen")})},increaseFont:function(){this.set({font_size:this.get("font_size")+1})},decreaseFont:function(){this.set({font_size:this.get("font_size")-1})},toggleToc:function(){this.set("toc_visible",
!this.get("toc_visible"))},goToHref:function(a){a=a.match(/([^#]*)(?:#(.*))?/);a[1]&&this.setSpinePos(this.packageDocument.spineIndexFromHref(a[1]));a[2]&&this.set({hash_fragment:a[2]})},getToc:function(){var a=this.packageDocument.getTocItem();return a?Readium.Models.Toc.getToc(a,{file_path:this.resolvePath(a.get("href")),book:this}):null},getCurrentSection:function(a){a||(a=0);return this.packageDocument.getSpineItem(this.get("spine_position")+a)},isFixedLayout:function(){return this.epub.isFixedLayout()},
restorePosition:function(){var a=Readium.Utils.getCookie(this.epub.get("key"));return parseInt(a,10)||this.packageDocument.getNextLinearSpinePostition()},savePosition:function(){Readium.Utils.setCookie(this.epub.get("key"),this.get("spine_position"),365)},resolvePath:function(a){return this.packageDocument.resolvePath(a)},hasNextSection:function(){return this.packageDocument.getPrevLinearSpinePostition(this.get("spine_position"))>-1},hasPrevSection:function(){return this.packageDocument.getNextLinearSpinePostition(this.get("spine_position"))>
-1},goToNextSection:function(){var a=this.packageDocument.getNextLinearSpinePostition(this.get("spine_position"));a>-1&&this.setSpinePos(a,!1)},goToPrevSection:function(){var a=this.packageDocument.getPrevLinearSpinePostition(this.get("spine_position"));a>-1&&this.setSpinePos(a,!0)},setSpinePos:function(a,b){if(!(a<0||a>=this.packageDocument.spineLength())){var c=this.get("rendered_spine_items").indexOf(a)>=0?!0:!1;this.set("spine_position",a);this.trigger("FXL_goToPage");c||this.set("rendered_spine_items",
this.paginator.renderSpineItems(b))}},setMetaSize:function(){this.meta_section&&this.meta_section.off("change:meta_height",this.setMetaSize);this.meta_section=this.getCurrentSection();this.meta_section.get("meta_height")&&this.set("meta_size",{width:this.meta_section.get("meta_width"),height:this.meta_section.get("meta_height")});this.meta_section.on("change:meta_height",this.setMetaSize,this)}});
