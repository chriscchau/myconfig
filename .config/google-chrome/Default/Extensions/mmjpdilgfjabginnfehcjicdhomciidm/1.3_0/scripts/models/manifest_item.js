Readium.Models.ManifestItem=Backbone.Model.extend({parseMetaTags:function(){var a;typeof this.get("meta_width")==="undefined"&&(this.isSvg()?a=this.parseViewboxTag():this.isImage()||(a=this.parseViewportTag()),a&&this.set({meta_width:a.width,meta_height:a.height}))},getContentDom:function(){var a=this.get("content");if(a)return(new window.DOMParser).parseFromString(a,"text/xml")},parseViewportTag:function(){var a=this.getContentDom();if(a){a=a.getElementsByName("viewport")[0];if(!a)return null;for(var a=
a.getAttribute("content"),a=a.replace(/\s/g,""),a=a.split(","),b={},c,d=0;d<a.length;d++)c=a[d].split("="),c.length===2&&(b[c[0]]=c[1]);b.width=parseFloat(b.width,10);b.height=parseFloat(b.height,10);return b}},parseViewboxTag:function(){var a=this.getContentDom();if(a){var a=a.documentElement.getAttribute("viewBox").split(/,?\s+|,/),b={};b.width=parseFloat(a[2],10);b.height=parseFloat(a[3],10);return b}},resolvePath:function(a){return this.collection.packageDocument.resolvePath(a)},resolveUri:function(a){return this.collection.packageDocument.resolveUri(a)},
isSvg:function(){return this.get("media_type")==="image/svg+xml"},isImage:function(){var a=this.get("media_type");return a&&a.indexOf("image/")>-1?a!=="image/svg+xml":!1},loadContent:function(){var a=this,b=this.resolvePath(this.get("href"));Readium.FileSystemApi(function(c){c.readTextFile(b,function(b){a.set({content:b})},function(){console.log("Failed to load file: "+b)})})}});
Readium.Models.SpineItem=Readium.Models.ManifestItem.extend({initialize:function(){this.isFixedLayout()&&(this.on("change:content",this.parseMetaTags,this),this.loadContent())},buildSectionJSON:function(a,b){if(!a)return null;var c=Object.create(null);c.width=this.get("meta_width")||0;c.height=this.get("meta_height")||0;c.uri=this.packageDocument.resolveUri(a.get("href"));c.page_class=this.getPageSpreadClass(a,b);return c},toJSON:function(){this.isFixedLayout()&&this.parseMetaTags();var a={};a.width=
this.get("meta_width")||0;a.height=this.get("meta_height")||0;a.uri=this.resolveUri(this.get("href"));a.page_class=this.getPageSpreadClass();return a},getPageSpreadClass:function(){var a=this.collection.packageDocument.get("book"),b=this.get("spine_index");return a.get("apple_fixed")?b===0?"center_page":b%2===1&&b===this.collection.length?"center_page":b%2===0?"right_page":"left_page":this.get("page_spread")?(a=this.get("page_spread"),a==="left"?"left_page":a==="right"?"right_page":"center_page"):
this.get("page_prog_dir")==="rtl"?b%2===0?"right_page":"left_page":b%2===0?"left_page":"right_page"},isFixedLayout:function(){return this.isSvg()||this.isImage()?!0:typeof this.get("fixed_flow")!=="undefined"?this.get("fixed_flow"):this.collection.isBookFixedLayout()},getPageView:function(){if(!this.view)this.view=this.isImage()?new Readium.Views.ImagePageView({model:this}):new Readium.Views.FixedPageView({model:this});return this.view},hasMediaOverlay:function(){return!!this.get("media_overlay")&&
!!this.getMediaOverlay()},getMediaOverlay:function(){return this.collection.getMediaOverlay(this.get("media_overlay"))}});Readium.Collections.ManifestItems=Backbone.Collection.extend({model:Readium.Models.ManifestItem,initialize:function(a,b){this.packageDocument=b.packageDocument}});
Readium.Collections.Spine=Backbone.Collection.extend({model:Readium.Models.SpineItem,initialize:function(a,b){this.packageDocument=b.packageDocument},isBookFixedLayout:function(){return this.packageDocument.get("book").isFixedLayout()},getMediaOverlay:function(a){return this.packageDocument.getMediaOverlayItem(a)}});
