Readium.Models.MediaOverlay=Backbone.Model.extend({audioplayer:null,smilModel:null,consoleTrace:!1,url:null,defaults:{current_text_src:null,has_started_playback:!1,is_document_done:!1,is_playing:!1,is_ready:!1},initialize:function(){var a=this;this.audioplayer=new Readium.Models.AudioClipPlayer;this.audioplayer.setConsoleTrace(!1);this.audioplayer.setNotifyOnPause(function(){a.set({is_playing:a.audioplayer.isPlaying()})});this.audioplayer.setNotifyOnPlay(function(){a.set({is_playing:a.audioplayer.isPlaying()})})},
setUrl:function(a){this.url=a},fetch:function(a){this.set({is_ready:!1});a=a||{};a.dataType="xml";Backbone.Model.prototype.fetch.call(this,a)},parse:function(a){var b=this;this.smilModel=new Readium.Models.SmilModel;this.smilModel.setUrl(this.url);this.smilModel.setNotifySmilDone(function(){b.debugPrint("document done");b.set({is_document_done:!0})});this.smilModel.addRenderers({audio:function(){var a=this;b.audioplayer.setNotifyClipDone(function(){a.notifyChildDone()});var c=!1;if(this.hasOwnProperty("isJumpTarget"))c=
this.isJumpTarget,this.isJumpTarget=!1;b.audioplayer.play($(this).attr("src"),parseFloat($(this).attr("clipBegin")),parseFloat($(this).attr("clipEnd")),c)},text:function(){var a=$(this).attr("src");b.debugPrint("Text: "+a);b.set("current_text_src",a)}});this.smilModel.build($(a).find("body")[0]);this.set({is_ready:!0})},startPlayback:function(a){this.get("is_ready")==!1?this.debugPrint("document not ready"):(this.set({is_document_done:!1}),this.set({has_started_playback:!0}),this.smilModel.render(a))},
pause:function(){this.get("is_ready")==!1?this.debugPrint("document not ready"):this.get("has_started_playback")==!1?this.debugPrint("can't pause: playback not yet started"):this.audioplayer.pause()},resume:function(){this.get("is_ready")==!1?this.debugPrint("document not ready"):this.get("has_started_playback")==!1?this.debugPrint("can't resume: playback not yet started"):this.audioplayer.resume()},findNodeByTextSrc:function(a){if(this.get("is_ready")==!1)return this.debugPrint("document not ready"),
null;if(a==null||a==void 0||a=="")return null;var b=this.smilModel.findNodeByAttrValue("text","src",a);b==null&&(b=this.smilModel.findNodeByAttrValue("seq","epub:textref",a));return b},setVolume:function(a){this.get("is_ready")==!1?this.debugPrint("document not ready"):this.audioplayer.setVolume(a)},reset:function(){this.set("current_text_src",null);this.set("has_started_playback",!1)},setConsoleTrace:function(a){this.consoleTrace=a},debugPrint:function(a){this.consoleTrace&&console.log("MediaOverlay: "+
a)}});
