Readium.Models.MediaOverlayController=Backbone.Model.extend({defaults:{active_mo:null,mo_text_id:null},initialize:function(){this.currentSection=this.mo=null;this.processingMoTextSrc=this.autoplayNextSpineItem=!1;this.currentView=this.pages=this.moTargetNode=null;this.epubController=this.get("epubController");this.epubController.on("change:spine_position",this.handleSpineChanged,this)},setPages:function(a){this.pages!=null&&this.pages.off();this.pages=a},setView:function(a){this.currentView=a},playMo:function(){if(this.mo==
null)alert("Sorry, there is no audio for this section.");else{this.set("active_mo",this.mo);this.mo.on("change:current_text_src",this.handleMoTextSrc,this);this.mo.on("change:is_document_done",this.handleMoDocumentDone,this);var a=this.moTargetNode;this.moTargetNode=null;if(this.currentSection.isFixedLayout())this.mo.get("has_started_playback")?this.resumeMo():this.mo.startPlayback(null);else{var b=-1,c=this.get("mo_text_id");c!=null&&c!=void 0&&c!=""&&(b=this.currentView.getElemPageNumberById(c));
this.pages.get("current_page").indexOf(b)!=-1?this.resumeMo():this.mo.startPlayback(a)}}},pauseMo:function(){this.mo&&(this.mo.off(),this.mo.pause(),this.set("active_mo",null))},reflowPageChanged:function(){if(!this.processingMoTextSrc&&!this.autoplayNextSpineItem){var a=this.get("active_mo")!=null;a&&this.pauseMo();this.setMoTarget();a&&this.playMo()}},pagesLoaded:function(){if(!this.currentSection.isFixedLayout()&&this.autoplayNextSpineItem==!0)this.autoplayNextSpineItem=!1,this.playMo()},resumeMo:function(){this.set("mo_text_id",
null);this.handleMoTextSrc();this.mo.resume()},handleMoTextSrc:function(){var a=this.mo.get("current_text_src");if(a==null)this.set("mo_text_id",null);else{this.processingMoTextSrc=!0;this.epubController.goToHref(a);var b="";a.indexOf("#")!=-1&&a.indexOf("#")<a.length-1&&(b=a.substr(a.indexOf("#")+1));this.set("mo_text_id",b);this.processingMoTextSrc=!1}},handleMoDocumentDone:function(){if(!(this.mo!=null&&this.mo!=void 0&&this.mo.get("is_document_done")==!1)&&(this.moTargetNode=null,this.pauseMo(),
this.epubController.hasNextSection()))this.autoplayNextSpineItem=!0,this.epubController.goToNextSection()},handleSpineChanged:function(){this.set("mo_text_id",null);if(this.epubController.getCurrentSection()!=this.currentSection){if(this.get("active_mo")!=null)this.autoplayNextSpineItem=!0,this.pauseMo();this.currentSection=this.epubController.getCurrentSection();this.mo=this.currentSection.getMediaOverlay();if(this.mo!=null&&(this.mo.reset(),this.currentSection.isFixedLayout()&&this.autoplayNextSpineItem))this.autoplayNextSpineItem=
!1,this.playMo()}},setMoTarget:function(){var a,b;if(this.mo!=null)if(this.currentSection.isFixedLayout())this.moTargetNode=null;else{a=this.currentView.findVisiblePageElements();var c=this.currentSection.get("href");b=null;console.log("\nVisible");for(var d=0;d<a.length;d++)if(b=$(a[d]).attr("id"),console.log(b),b=this.mo.findNodeByTextSrc(c+"#"+b))break;this.moTargetNode=b}}});
