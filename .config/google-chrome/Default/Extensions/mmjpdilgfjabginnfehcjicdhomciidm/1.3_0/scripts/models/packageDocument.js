Readium.Models.PackageDocument=Backbone.Model.extend({initialize:function(a){var b=this;if(a.file_path)this.file_path=a.file_path,Readium.FileSystemApi(function(a){a.getFsUri(b.file_path,function(a){b.uri_obj=new URI(a)})});else throw"This class cannot be synced without a file path";this.on("change:spine_position",this.onSpinePosChanged)},onSpinePosChanged:function(){this.get("spine_position")>=this.previous("spine_position")?this.trigger("increased:spine_position"):this.trigger("decreased:spine_position")},
validate:function(a){if(!a.manifest&&!this.get("manifest"))return"ERROR: All ePUBs must have a manifest";var b=a.spine||this.get("spine");if(!b)return"ERROR: All ePUBs must have a spine";if(a.spine_position<0||a.spine_position>=b.length)return"ERROR: invalid spine position"},sync:BBFileSystemSync,defaults:{spine_position:0},getManifestItemById:function(a){return this.get("manifest").find(function(b){if(b.get("id")===a)return b})},getSpineItem:function(a){return this.get("res_spine").at(a)},spineLength:function(){return this.get("res_spine").length},
getNextLinearSpinePostition:function(a){var b=this.get("res_spine");if(a===void 0||a<-1)a=-1;for(;a<b.length-1;)if(a+=1,b.at(a).get("linear")!=="no")return a;return-1},getPrevLinearSpinePostition:function(a){var b=this.get("res_spine");if(a===void 0||a>b.length)a=b.length;for(;a>0;)if(a-=1,b.at(a).get("linear")!=="no")return a;return-1},goToNextSection:function(){this.set({spine_position:this.get("spine_position")+1})},goToPrevSection:function(){this.set({spine_position:this.get("spine_position")-
1})},spineIndexFromHref:function(a){for(var b=this.get("res_spine"),a=this.resolveUri(a).replace(/#.*$/,""),c=0;c<b.length;c++){var d=b.at(c).get("href"),d=this.resolveUri(d).replace(/#.*$/,"");if(d===a)return c}return-1},goToHref:function(a){var b=this.get("spine"),c=this.get("manifest"),d=this,a=d.resolveUri(a).replace(/#.*$/,""),c=c.find(function(b){var c=d.resolveUri(b.get("href")).replace(/#.*$/,"");if(a==c)return b});if(!c)return null;for(var c=c.get("id"),e=0;e<b.length;++e)if(b[e].idref===
c){this.set({spine_position:e},{silent:!0});this._previousAttributes.spine_position=0;this.trigger("change:spine_position");break}},getTocItem:function(){var a=this.get("manifest"),b=this.get("metadata").ncx,c=a.find(function(a){return a.get("properties")==="nav"});return c?c:b&&b.length>0?a.find(function(a){return a.get("id")===b}):null},getMediaOverlayItem:function(a){var b=this.get("mo_map");return b&&b[a]},crunchSpine:function(a,b){var c=this,d=-1,e=_.map(a,function(a){d+=1;var e=b.find(function(b){if(b.get("id")===
a.idref)return b}),f=c.get("book");return _.extend({},a,e.attributes,{spine_index:d},{page_prog_dir:f.get("page_prog_dir")})});return new Readium.Collections.Spine(e,{packageDocument:this})},parse:function(a){a=(new Readium.Models.PackageDocumentParser(this.uri_obj)).parse(a);a.res_spine=this.crunchSpine(a.spine,a.manifest);return a},resolveUri:function(a){uri=new URI(a);return uri.resolve(this.uri_obj).toString()},resolvePath:function(a){var b=this.file_path,a=a.indexOf("../")===0?a.substr(3):a,
c=b.lastIndexOf("/");return b.substr(0,c)+"/"+a}});
