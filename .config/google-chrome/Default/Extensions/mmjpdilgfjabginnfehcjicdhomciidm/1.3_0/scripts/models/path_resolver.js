window.resolveLocalFileSystemURL=window.resolveLocalFileSystemURL||window.webkitResolveLocalFileSystemURL;window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder;window.g_uid_hashed=null;function PathResolver(a){this.baseUrl=new URI(a)}function encode_utf8(a){return unescape(encodeURIComponent(a))}function string2Bin(a){for(var c=[],b=0;b<a.length;b++)c.push(a.charCodeAt(b)&255);return c}
function string2ArrayBuffer(a){for(var c=new ArrayBuffer(a.length),b=new Uint8Array(c),d=0;d<a.length;d++)b[d]=a.charCodeAt(d);return c}function bin2String(a){return String.fromCharCode.apply(String,a)}PathResolver.prototype.resolve=function(a){return(new URI(a)).resolve(this.baseUrl)};
var domToString=function(a){return(new XMLSerializer).serializeToString(a)},fixCssLinks=function(a,c){var a=a.replace(/@import\s+(?:url\()*(.+?)(?:\))*\s*;/g,"@import url($1);"),b=/url\s*\(\s*['"]*\s*/,d=/['"]*\s*\)/;return a.replace(/url\s*\(\s*.+?\s*\)/g,function(a){a=a.replace(b,"");a=a.replace(d,"");return"url('"+c.resolve(a)+"')"})},fixXhtmlLinks=function(a,c){var b,d,f=(new window.DOMParser).parseFromString(a,"text/xml"),e=function(a){$("["+a+"]",f).each(function(){b=$(this);d=b.attr(a);d=c.resolve(d);
b.attr(a,d)})};e("src");e("href");$("image",f).each(function(){b=$(this);d=b.attr("xlink:href");d=c.resolve(d);b.attr("xlink:href",d)});if(e=f.getElementsByTagName("head")[0]){var g=e.innerHTML,g="<script type='text/javascript' src='"+window.location.origin+"/scripts/epub_reading_system.js' ><\/script>"+g;e.innerHTML=g}return domToString(f)},fixFonts=function(a){if(a.indexOf("OTTO")==0||a.indexOf("wOFF")==0)return a;else{for(var c=a.slice(0,1040),c=string2Bin(c),b=g_uid_hashed.length,d=0;d<1040;d++)c[d]^=
g_uid_hashed[d%b];return bin2String(c)+a.slice(1040)}},getBinaryFileFixingStrategy=function(a,c){if(a.substr(-4)===".otf"||a.substr(-5)===".woff"||a.substr(-4)===".OTF"||a.substr(-5)===".WOFF"){if(window.g_uid_hashed==null){var b=encode_utf8(c.trim()),b=window.Crypto.SHA1(b,{asBytes:!0});window.g_uid_hashed=b}return fixFonts}return null},getLinkFixingStrategy=function(a){return a.substr(-4)===".css"?fixCssLinks:a.substr(-5)===".html"||a.substr(-6)===".xhtml"?fixXhtmlLinks:a.substr(-4)===".xml"?fixXhtmlLinks:
null},monkeyPatchUrls=function(a,c,b,d){var f,e,g=new PathResolver(a),i=function(a){a=e(a,g);writeBinEntry(f,a,c,b)};e=getBinaryFileFixingStrategy(a,d);if(e!=null)window.resolveLocalFileSystemURL(a,function(a){f=a;readBinEntry(f,i,b)}),c();else{var h=getLinkFixingStrategy(a);if(h===null)c();else{var j=function(a){a=h(a,g);writeEntry(f,a,c,b)};window.resolveLocalFileSystemURL(a,function(a){f=a;readEntry(f,j,b)})}}},readEntry=function(a,c,b){a.file(function(a){var b=new FileReader;b.onloadend=function(){c(this.result)};
b.readAsText(a)},b)},writeEntry=function(a,c,b,d){Readium.FileSystemApi(function(f){f.writeFile(a.fullPath,c,b,d)})},readBinEntry=function(a,c,b){a.file(function(a){var b=new FileReader;b.onloadend=function(){c(this.result)};b.readAsBinaryString(a)},b)},writeBinEntry=function(a,c,b,d){a.createWriter(function(a){a.onwriteend=function(){b()};a.onerror=function(a){d(a)};var e=new BlobBuilder,g=string2ArrayBuffer(c);e.append(g);e=e.getBlob("image/jpeg");a.write(e)},d)};
